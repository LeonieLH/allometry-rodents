---
title: "04-plot-evolutionary-allometry"
author: "Ariel Marcy"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Plot PCA and evolutionary allometry
Here we plot the Principal Components Analysis to visualize morphological variation. PC1 is highly correlated allometric shape. We also plot evolutionary allometry to visualize species which diverge.

This script generates Figure 2. 

### Load packages, functions, and data
```{r message = FALSE}
library(stringr)
library(geomorph)
library(plotrix)  # needed to draw ellipses
source("../Functions/utilities.R")  # loads custom functions
load(file = "../Data/Processed/02-main-data.rda")
load(file = "../Data/Processed/03-color-data.rda")
```

## Set up shape array for evolutionary allometric and phylogentic analyses
First, attach long form names for genus and species to the metadata.
```{r}
# Get names from trait information gathered from Native Mice and Rats by Dr.s Bill Breed and Fred Ford (2007). 
traits <- read.csv("../Data/Processed/in_ex_traits.csv", header = TRUE)
traits$Taxa <- paste(str_sub(traits$Genus, 1, 1), str_sub(traits$Species, 1, 3), sep = "_")  # make matching Taxa column
info.traits <- merge(info, traits, by = "Taxa", sort = F)
info.traits <- info.traits[order(info.traits$Order), ]  # preserve shape specimen order

# Rename Genus & Species columns so they have their old, short column name, long form Genus and Species columns keep Genus.y and Species.y
names(info.traits)[names(info.traits) == 'Genus.x'] <- 'Genus'
names(info.traits)[names(info.traits) == 'Species.x'] <- 'Species'

info.phylo <- info.traits[, -c(5:7)]  # remove unnecessary columns
```

Second, rename shape dataset dimnames to only "Genus_species". This is so we can re-order the shape data to match the tree later on. (We can still reference the CatNum in the metadata.)
```{r}
shape.phylo <- shape  # initiate shape optimized for phylogenetics
dimnames(shape.phylo)[[3]] <- as.list(paste(info.phylo$Genus.y, info.phylo$Species.y, sep = "_"))
```

## Calculate mean shape and centroid size for each species
This step has to be done before plotting evolutionary allometry and working with the phylogeny.

The mean shape function, `mshape()` outputs a 2D array. Therefore, the `for` loop below stores mean shapes in a 2D array format recognized by `geomorph`: (n x [p x k]), where n is number of specimens, p is number of landmark points, and k is number of dimensions. Finally, we convert to a 3D array with format (p x k x n) since a 3D array is required by most `geomorph` functions. 
```{r}
info.phylo$FullName <- paste(info.phylo$Genus.y, info.phylo$Species.y, sep = "_")  # give names to metadata in the same format as the tree, "Genus_species"
full.names <- unique(info.phylo$FullName)  # list of species

# For loop to subset shape data by species and calculate mean shape
mean.shapes.2D <- NULL  # initiate blank data frame
for (i in 1:length(full.names)) {  
        is.taxa <- which(info.phylo$FullName == full.names[i])
        shape.for.mean.2D <- shape.phylo[, , is.taxa]
        mean.shapes.2D <- rbind(mean.shapes.2D, mshape(shape.for.mean.2D))  # output cols must = 3 for 3D
}
mean.shapes <- arrayspecs(mean.shapes.2D, 325, 3)  # convert to 3D array with 325 landmarks and 3 for 3D landmarks in this study
```

Create metadata and put mean shape and metadata in alphabetical order.
```{r}
# Alphabetical order for mean shape
dimnames(mean.shapes)[[3]] <- full.names  # Genus_species format
mean.shapes <- mean.shapes[, , sort(dimnames(mean.shapes)[[3]])]  # ABC

# Alphabetical order for mean shape metadata
info.means <- info.phylo[!duplicated(info.phylo$Taxa), -c(4:6)]  # make metadata; remove outdated columns: CatNum, Csize, Order
info.means <- info.means[order(info.means$FullName), ]  # ABC order
```

### Calculate mean centroid size
We need to update the centoid size column for info.means to contain the *mean* centroid size by taxa. Centroid size for all 317 specimens is stored in the info.phylo metadata table.
```{r}
# Calculate mean centroid size and store in info.means
cs.means <- aggregate(info.phylo[, 6], list(Taxa = info.phylo$FullName), mean)  # aggregate also alphabetizes it
info.means$MeanCsize <- cs.means[, 2]  # store in vector
```

## Make multipanel Figure 2: mean shape PCA and evolutionary allometry
First, set up colors and points by genera and important taxa
```{r}
# Make an Effective Genus column to categorize Mastacomys phylogenetically within Pseudomys
info.means$EGenus <- info.means$Genus
info.means$EGenus[which(info.means$Genus == "Mas")] <- "Pse"

# Colors for genera and different points by species within each genus; used for PCA
col.means <- PlotByGroup(info.means, "EGenus", col.gen)  # standard colors from script 03
pch.means <- PointOutDiffSpp(info.means)  # pts by unique species in a genus
pch.means[which(info.means$Taxa == "M_fus")] <- 2  # open triangle

# Points to call out only specialized herbivores with special characters; used for Evolutionary Allometry plot
pch.evo.allo <- rep(16, length(col.means))  # other taxa are circles
pch.evo.allo[which(info.means$Taxa == "P_ora")] <- 11  # star
pch.evo.allo[which(info.means$Taxa == "M_fus")] <- 2  # open triangle
```

### Run PCA and find Pearson's correlations for PC1 and PC2 with size
```{r}
pca.means <- plotTangentSpace(mean.shapes)  # PCA of mean shapes

# Write x and y labels with proportion of variance for PC1 and PC2
PCs <- pca.means$pc.summary$importance
PC1.per <- round(PCs[2, 1] * 100, digits = 1)  # % with 1 decimal
PC1.lab <- paste("PC", 1, " (", PC1.per, "%)", sep = "")
PC2.per <- round(PCs[2, 2] * 100, digits = 1)
PC2.lab <- paste("PC", 2, " (", PC2.per, "%)", sep = "")

# Find Pearson's r for correlation with PC1
cor <- cor.test(log(info.means$MeanCsize), pca.means$pc.scores[, 1], method = "pearson")
cor.assoc <- round(unname(cor$estimate), digits = 3)  # 3 sig figs
cor.assoc
cor$p.value  # reported in paper

# Find Pearson's r for correlation with PC2
cor2 <- cor.test(log(info.means$MeanCsize), pca.means$pc.scores[, 2], method = "pearson")
cor.assoc2 <- round(unname(cor2$estimate), digits = 3)  # 3 sig figs
cor.assoc2
cor2$p.value  # reported in paper
```

### Generate data for Evolutionary Allometry plot
```{r}
# Run allometry on all 34 species
evo.procD <- geomorph.data.frame(shape = mean.shapes, size = info.means$MeanCsize, genus = info.means$Genus)
mean.allo <- procD.allometry(shape ~ log(size), data = evo.procD)

# Find correlation of mean shape to log centroid size
cor.allo <- cor.test(log(info.means$MeanCsize), mean.allo$Reg.proj, method = "pearson")
cor.allo.short <- round(cor.allo$estimate, 2)  # 2 sig figs
```

### Plot and export the multi-panel Figure 2
PCA on top and evolutionary allometry plot on the bottom
```{r}
setEPS()  # sets up plot export
postscript("../Data/Results/Figure2_PCA_EvoAllo2.eps")
layout(matrix(c(1,1,2,2), 2, 2, byrow = TRUE))  # 2 rows, 2 columns

# PCA plot
plot(x = -pca.means$pc.scores[, 1],
     y = pca.means$pc.scores[, 2],
     xlim = c(-0.08, 0.12),
     ylim = c(-0.08, 0.12),
     col = col.means,
     pch = pch.means,
     bg = col.means,
     main = "a) Principal Component Analysis",
     xlab = PC1.lab, 
     ylab = PC2.lab)
text(.105, -0.003, "Frugivores", col = "dark grey")
draw.ellipse(.116, .015, .006, .012, angle = -12, border = "dark grey")

text(.085, 0.041, "Herbivores", col = "dark grey")
draw.ellipse(.048, .035, .025, .013, angle = -19, border = "dark grey")

text(.045, -0.054, "Carnivores", col = "dark grey")
draw.ellipse(.044, -.073, .034, .007, angle = -15, border = "dark grey")

text(-.055, 0.035, "Notomys", col = "dark grey")
draw.ellipse(c(-.053, -0.07), c(.014, -0.013), c(.015, .004), c(.004, .007), angle = c(-95, 0), border = c("dark grey", "dark grey"))  # draws both

# Evolutionary Allometry plot
plot(x = log(info.means$MeanCsize),
     y = mean.allo$Reg.proj,
     xlim = c(4.75, 6),
     col = col.means, 
     pch = pch.evo.allo,
     main = "b) Evolutionary Allometry",
     xlab = "Log centroid size", 
     ylab = "Shape (proj. reg. score)")
legend(5.81, 0.052, legend = names.phylo, col = col.phylo, pch = 16, cex = 1, pt.cex = 1, ncol = 2)

abline(lm(mean.allo$Reg.proj ~ log(info.means$MeanCsize)), col = "dark grey", lwd = 1)  # plots evolutionary allometry line of best fit
text(4.81, 0.105, paste("r = ", cor.allo.short), col = "dark grey")

text(5.75, 0.11, "Frugivores", col = "dark grey")
draw.ellipse(5.92, .115, .08, .005, angle = 1, border = "dark grey")

text(5.35, 0.08, "Herbivores", col = "dark grey")
draw.ellipse(5.41, .047, .11, .02, angle = 5, border = "dark grey")

text(5.8, 0.066, "Carnivore", col = "dark grey")
text(5.03, 0.015, "Carnivore", col = "dark grey")

text(5.3, -0.065, "Hopping Notomys", col = "dark grey")
draw.ellipse(5.12, -0.055, .075, .012, angle = 8, border = "dark grey")

dev.off()  # finishes plot export
```

### Save intermediate data
```{r}
save(mean.shapes, info.means, file = "../Data/Processed/04-mean-data.rda")
```