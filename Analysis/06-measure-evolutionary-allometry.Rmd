---
title: "06-measure-evolutionary-allometry"
author: "Ariel Marcy"
date: "2/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Phylogenetic analyses
Evolutionary studies must take into account the phylogenetic tree because related species do not behave the same as independent samples. 

Many of these steps are based on Dr Meriam Zelditch et al.'s A Practical Companion (2012). 
> Zelditch ML Swiderski D Sheets HD. 2012. A practical companion to geometric morphometrics for biologists: running analyses in freely-available software. Available at: http://booksite.elsevier.com/9780123869036.

### Load packages, functions, and data from previous steps
```{r message = FALSE}
library(stringr)
library(ape)  # needed to work with phylogenies
library(geiger)  # needed to work with phylogenies
library(data.table)
library(vegan)
library(geomorph)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/02-main-data.rda")
load(file = "../Data/Processed/03-color-data.rda")
load(file = "../Data/Processed/04-mean-data.rda")
```

## Prepare the tree data for phylogenetic analyses
The commands in `geomorph` require the tree and datasets to have exactly the same set of species.

### Load in phylogenetic tree
The most recent tree for Australian rodents is from Smissen & Rowe 2018. The tree is a fossil calibrated ultrametric tree from BEAST2 for Hydromini, which includes all the Australo-Papuan old endemics in Murinae.

This tree adds 6 more species from Australia to the Smissen & Rowe phylogeny. 
```{r}
raw.tree <- read.nexus("../Data/Processed/Marcy-BEAST01.con.tre")
```

### Extract only Genus and Species names from the tree
The tree file has uneven amounts of information for each entry, some entries have catalog numbers and others do not. Therefore we needed a `for` loop to grab the first two elements from a list, which always corresponded to Genus and Species.

We reassign only Genus and Species names (in the form "Genus_species") to the tree so that it is easier to compare to the shape data. 
```{r}
no.cat.tree <- raw.tree  # initiate new, modified tree with no CatNums
label.list <- strsplit(raw.tree$tip.label, "_")  # separate info into list

# For loop finds Genus & Species and makes tip name "Genus_species"
for (i in 1:length(label.list)) {
        label <- unlist(label.list[i])
        no.cat.tree$tip.label[i] <- paste(label[1], label[2], sep = "_")
}
```

### Rename node
Since the 2018 Smissen & Rowe tree focused primarily on New Guinea species, it does not have all of the Australian species in our shape dataset. However, it does include sister species with the same relative branch length to other genera in the study. Therefore, we decided to rename one of the nodes to the sister Australian species. 

**Renamed node:**
_Pogonomys loriae_ (NG) to _Pogonomys mollipilosus_ (Aus)

```{r}
renamed.tree <- no.cat.tree
P.lor <- which(str_detect(no.cat.tree$tip.label, "Pogonomys_loriae"))
renamed.tree$tip.label[P.lor] <- paste("Pogonomys_mollipilosis")
```

### Prune the tree and shape datasets to match each other
Now that the names in the Smissen & Rowe tree can be compared to our info.phylo metadata, we can prune both datasets to have the same species.

First, prune the tree of species not in the shape data
```{r}
concord <- name.check(renamed.tree, renamed.tree$tip.label, dimnames(mean.shapes)[[3]])  # check concordance
aus.tree <- drop.tip(renamed.tree, concord$tree_not_data)  # prune tree to Aus sample
```

Second, remove duplicates of species in the tree
```{r}
dupes <- which(duplicated(aus.tree$tip.label))
aus.tree <- drop.tip(aus.tree, dupes)
```

Third, subset and re-order the metadata and shape datasets to match the order of species found in the tree. 
```{r}
# Subsetting
to.remove <- name.check(aus.tree, aus.tree$tip.label, dimnames(mean.shapes)[[3]])
info.means.tree <- info.means[!is.element(info.means$FullName, to.remove$data_not_tree), ]  # metadata
mean.shapes.tree <- mean.shapes[, , !is.element(info.means$FullName, to.remove$data_not_tree)]  # shape data

# Re-order to match tree tip order
tree.order <- match(aus.tree$tip.label, info.means.tree$FullName)
info.means.tree <- info.means.tree[tree.order, ]  # metadata
mean.shapes.tree <- mean.shapes.tree[, , tree.order]  # shape data
```

## Phylogenetic Analyses
First, test for phylogenetic signal in the shape data. 
```{r}
physignal(mean.shapes.tree, aus.tree, iter = 500)
```

### Evolutionary Allometry, reported in Table 1
Here we run Procrustes ANOVAs to compare the relative impact of genus, size, and their interaction on shape. Because the interaction term was very small, we ran a second ANOVA without the interaction term in order to compare the means of genus and log centroid size.
```{r}
# Procrustes ANOVA with interaction
evo.allo.gen.gdf <- geomorph.data.frame(Shape = mean.shapes.tree, CS = info.means.tree$MeanCsize, Genus = info.means.tree$Genus)
evo.allo.gen <- procD.pgls(Shape ~log(CS) * Genus, aus.tree, iter = 500, data = evo.allo.gen.gdf)
evo.allo.gen

# Procrustes ANOVA without interaction
evo.allo.gen.2 <- procD.pgls(Shape ~log(CS) + Genus, aus.tree, iter = 500, data = evo.allo.gen.gdf)
evo.allo.gen.2
```

### Export Tables 1a and 1b as CSV files
```{r}
# Round all values to 3 decimals and remove NAs from the tables
table1a <- as.data.frame(round(evo.allo.gen$aov.table, 3))
table1a[is.na(table1a)] <- ""
table1b <- as.data.frame(round(evo.allo.gen.2$aov.table, 3))
table1b[is.na(table1b)] <- ""

# Export
write.table(table1a, "../Data/Results/Table1a_ANOVA_int.csv", sep = ",", col.names = NA)
write.table(table1b, "../Data/Results/Table1b_ANOVA_no_int.csv", sep = ",", col.names = NA)
```

### Save intermediate data
```{r}
save(mean.shapes.tree, info.means.tree, aus.tree, file = "../Data/Processed/06-phylo-data.rda")
```