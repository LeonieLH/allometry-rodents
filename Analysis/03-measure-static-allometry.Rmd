---
title: "03-measure-static-allometry"
author: "Ariel Marcy"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Static Allometry
Changing size is one of the most common ways that organisms can change their shape. Modifications to growth during development often have a profound impact on adult shape. The tests in this script detect how much size appears to drive shape change in our sample.

This script generates Figure 1. 

### Load packages, functions, and data
```{r message = FALSE}
library(stringr)
library(data.table)
library(geomorph)
library(wesanderson)  # colors
source("../Functions/utilities.R")  # loads custom functions
load(file = "../Data/Processed/02-main-data.rda")
```

### Set up for analyses
Since *Mastacomys* is technically within the genus *Pseudomys* (Smissen & Rowe 2018), we'll make an "Effective Genus" column where this genus is classified under *Pseudomys*.
```{r}
# Make Effective Genus column
info$EGenus <- info$Genus
info$EGenus[which(info$Genus == "Mas")] <- "Pse"  # Mas becomes Pseudomys
```

Colors for subsequent figures are set up according to column "EGenus". Colors roughtly correspond to phylogenetics such that similar color hues indicate closer evolutionary relationships.
```{r}
# Choose colors from attractive Wes Anderson palettes
GB1 <- wes_palette("GrandBudapest1")  # Uromyini clade
GB2 <- wes_palette("GrandBudapest2")  # Conilurus clade
Z1 <- wes_palette("Zissou1", 6, "continuous") # Pseudomys clade
BR1 <- wes_palette("BottleRocket1")  # Carnivores and Pogonomys
IoD1 <- wes_palette("IsleofDogs1")  # Mus and Rattus

# Colors in order of phylogeny
names.phylo <- c("Mel", "Uro", "Con", "Mes", "Lep", "Leg", "Zyz", "Not", "Pse", "Hyd", "Xer", "Pog", "Mus", "Rat")
col.phylo <- c(IoD1[1], GB1[2], GB2[1], GB2[2], GB2[4], Z1[5], Z1[4], Z1[3], Z1[1], BR1[3], GB1[3], BR1[4], IoD1[6], IoD1[4])
names(col.phylo) <- names.phylo

# Colors in order of alphabetical genus names
col.gen <- col.phylo[match(sort(unique(info$EGenus)), names(col.phylo))]
sp.col.gen <- col.phylo[match(as.factor(info$EGenus), names(col.phylo))]  # color vector for all data
```

## 1) Measure static allometry: Homogeneity of Slopes Test by species
Isolate only those species with at least 8 specimens.
```{r}
spec.counts <- as.data.frame(table(info$Taxa))
to.remove <- spec.counts[which(spec.counts$Freq <= 7), ]
species.rm <- as.vector(to.remove$Var1)

# For loop to take out these specimens
dataset.rm <- NULL  # initiate blank data frame
for(n in 1:dim(to.remove)[1]) {
        dataset.rm <- c(dataset.rm, which(info$Taxa == species.rm[n]))
}

# Remove species from:
info.HOS <- info[c(-dataset.rm), ]  # Metadata
shape.HOS <- shape[, , c(-sort(dataset.rm))]  # Shape dataset
```

Run allometry tests as well as a homogeneity of slopes test. These tests take about 5 min to run. 
```{r}
# Run static allometry test
spp.gdf <- geomorph.data.frame(shape = shape.HOS, spp = info.HOS$Taxa, size = info.HOS$Csize)
spp.results <- procD.allometry(shape ~ log(size), f2 = ~spp, iter = 499, data = spp.gdf)

# Examine results
spp.results$aov.table
spp.results$HOS.test
summary(spp.results)

# Find pair-wise p-values for slopes for each taxa
size <- info.HOS$Csize
spp <- info.HOS$Taxa
pwHOS.spp <- advanced.procD.lm(f1 = shape.HOS ~log(size) + spp, 
                                     f2 = ~log(size) * spp, 
                                     groups = ~spp,  
                                     slope = ~log(size),
                                     iter = 499,
                                     angle.type = "deg")

# Correct for multiple comparisons
#pwHOS.pvals <- p.adjust(pwHOS.spp$P.slopes.dist, method = "hommel")  # Hommel is a more powerful method for independent hypothesis tests

# Turn back into data frame
#HOS.matrix <- matrix(pwHOS.pvals, nrow = dim(pwHOS.spp$P.slopes.dist)[1], ncol = dim(pwHOS.spp$P.slopes.dist)[2])
#rownames(HOS.matrix) <- rownames(pwHOS.spp$P.slopes.dist)
#colnames(HOS.matrix) <- colnames(pwHOS.spp$P.slopes.dist)

# Export p-value matrix
write.csv(HOSresults, "../Data/Results/TableS4_HOS_test2.csv")  # save in Results folder
```

## 2) Visualize static Allometry: Predicted Value
In _geomorph_, static allometry can be visualized with log(centroid size) plotted versus the projected regression score of shape ~ size, a common way of quantifying "size-less" shape.
```{r}
# Run static allometry test with all specimens
spp.gdf <- geomorph.data.frame(shape = shape, spp = info$Taxa, size = info$Csize)
spp.results <- procD.allometry(shape ~ log(size), f2 = ~spp, iter = 499, data = spp.gdf)

# Set colors for genera and different points for species within each genus
pch.unique.spp <- PointOutDiffSpp(info)  # points by unique species in a genus for legend
pch.unique.spp[which(sort(unique(info$Taxa)) == "M_fus")] <- 2
pch.spp <- PlotByGroup(info, "Taxa", pch.unique.spp)  # pch coded for each individual

# Make color vector for legend
unique.taxa <- as.data.frame(unique(info[, c(6,10)]))
unique.taxa <- na.omit(unique.taxa[order(unique.taxa), ])
col.unique.spp <- PlotByGroup(unique.taxa, "EGenus", col.gen)

# Find the mean point for each static allometry
mean.size <- aggregate(spp.results$size, list(Taxa = info$Taxa), mean)
mean.shape <- aggregate(spp.results$Reg.proj, list(Taxa = info$Taxa), mean)
```

### Plot/export static and evolutionary allometry multipanel Figure 1
Here we consolidate the information above into two static allometry plots, one with all the data points and one with just the regression lines for each species to compare with the evolutionary allometry of the entire group. 
```{r}
setEPS()  # sets up plot export
postscript("../Data/Results/Figure1_Static_Evo_Allo7.eps")
layout(matrix(c(1,1,2,2), 2, 2, byrow = TRUE))

# Plot of all data points with evolutionary allometry
par(mar = c(1, 4, 1.5, 0))
plot(x = log(spp.results$size),
     y = spp.results$Reg.proj,
     xlim = c(4.7, 6.4),
     col = sp.col.gen, 
     pch = pch.spp,
     bg = sp.col.gen,
     main = "Static and evolutionary allometry",
     xlab = NA,
     ylab = "Shape (Proj. Reg. Score)")
abline(lm(mean.shape$V1 ~ log(mean.size$x)), col = "dark grey", lwd = 2)  # plots evolutionary allometry
text(min(log(spp.results$size)), max(spp.results$Reg.proj), "a")

# Species Legend
legend(6.05, 0.06, legend = sort(unique(info$Taxa)), col = col.unique.spp, border = NULL, pch = pch.unique.spp, pt.bg = col.unique.spp, cex = 0.97, pt.cex = 1, ncol = 2, bg = "white")

# Plot of static allometry with evolutionary allometry
par(mar=c(5, 4, 1.5, 0))
plot(x = log(spp.results$size),
     y = spp.results$Reg.proj,
     xlim = c(4.7, 6.4),
     col = "white", 
     pch = pch.spp,
     bg = "white",
     xlab = "Log centroid size", 
     ylab = "Shape (Proj. Reg. Score)")
abline(lm(mean.shape$V1 ~ log(mean.size$x)), col = "dark grey", lwd = 2)  # plots evolutionary allometry
text(6.2, 0.02, paste("r = ", cor.static.assoc), cex = 1.3, col = "dark grey")
text(min(log(spp.results$size)), max(spp.results$Reg.proj), "b")

# Line segments to represent the static allometry for each species
taxa <- sort(unique(info$Taxa))  # ABC order
for(i in 1:length(taxa)) {
        # Isolate size and shape info for each taxon
        taxon.size <- spp.results$size[which(info$Taxa == taxa[i])]
        taxon.shape <- spp.results$Reg.proj[which(info$Taxa == taxa[i])]
        
        # Find parameters of regression line
        lm.params <- lm(taxon.shape ~ log(taxon.size))
        lm.slope <- unname(lm.params$coefficients[2])
        lm.int <- unname(lm.params$coefficients[1])

        # Draw regression line segment between min and max points 
        x.0 <- min(log(taxon.size))
        y.0 <- x.0 * lm.slope + lm.int  # y = mx + b
        x.1 <- max(log(taxon.size))
        y.1 <- x.1 * lm.slope + lm.int  # y = mx + b
        segments(x.0, y.0, x.1, y.1, col = col.unique.spp[i], lwd = 1.5)
}
dev.off()
```

### Save intermediate data
```{r}
save(col.gen, sp.col.gen, col.phylo, names.phylo, file = "../Data/Processed/03-color-data.rda")
```