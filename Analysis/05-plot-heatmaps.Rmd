---
title: "05-plot-heatmaps"
author: "Ariel Marcy"
date: "2/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Plot allometry heatmaps
PC1 corresponded to predicted allometric shape. Here we plot the shape differences across PC1 min and PC1 max to detect what shape changes occur.

### Load packages, functions, and data from previous steps
```{r message = FALSE}
# Load libraries (and install if necessary) for landvR package
if(!require(devtools)) install.packages("devtools")
if(!require(dispRity)) install.packages("dispRity")
if(!require(landvR)) install_github("TGuillerme/landvR")
library(data.table)
library(vegan)
library(geomorph)
source("../Functions/utilities.R")  # custom functions
load(file = "../Data/Processed/02-main-data.rda")
```

## Landmark variation heatmaps
Here we use Dr Thomas Guillerme's new package, `landvR` to see how landmarks vary within and between the two protocols. Much of the below was adapted from [this vignette written by Dr Guillerme](https://cdn.rawgit.com/TGuillerme/landvR/8a6a6bd5/inst/vignettes/Landmark_partition_test.html).

```{r}
# Find mean configuration - i.e. mean shape in dataset
consensus <- (select.procrustes(shape, selector = mean))[[1]]

# Measure spherical coordinates differences from the mean for each specimen for each landmark
diff.from.mean <- coordinates.difference(coordinates = shape, reference = consensus, type = "spherical")

# Ordinate the data
twoD.shape <- two.d.array(shape)
ordination <- stats::prcomp(twoD.shape)

# Force the symmetric component of shape into class "gpagen" (required for variation.range)
gpagen.shape <- list()
gpagen.shape$coords <- shape
gpagen.shape$consensus <- consensus
class(gpagen.shape) <- "gpagen"

# Measure extremes of variation from mean on PC1
PC1.var <- variation.range(gpagen.shape, return.ID = FALSE, axis = 1, ordination = ordination, type = "spherical")

# Wrap specimens on the tangent space
wrap.PCA <- plotTangentSpace(shape, verbose = FALSE)

# Select extreme specimens (the ones that make the warp-meshes)
hypothetical.1 <- wrap.PCA$pc.shapes[[1]]
hypothetical.2 <- wrap.PCA$pc.shapes[[2]]

# Plot the range of variation along PC1 using a heat color scheme
PC1.var.plot <- procrustes.var.plot(hypothetical.1, hypothetical.2, col = heat.colors, col.val = PC1.var[, "radius"], labels = F)
```