---
title: "03-measure-allometry"
author: "Ariel Marcy"
date: "2019-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Allometry and Morphological Disparity
Changing size is one of the most common ways that organisms can also change their shape. Modifications to growth during development often have a profound impact on adult shape. The tests in this script detect how much size appears to drive shape change in our sample. 

Morphological disparity tests how much Procrustes variation exists within each group (species, clade, or wave) and whether that variation is significantly different from the variation within another group. Strong allometry can constrain variation, therefore a higher morphological disparity could suggest a species' evolution is less constrained by allometry than another's. 

### Load packages, functions, and data
```{r message = FALSE}
# library(devtools)  # needed to install dispRity package
# install_github("TGuillerme/dispRity", ref = "release")  # needed only once
library(dispRity)
library(stringr)
library(data.table)
library(geomorph)
source("../Functions/utilities.R")  # loads custom functions
load(file = "../Data/Processed/02-main-data.rda")
```

### Set up for analyses
Since Mastacomys is technically within the genus Pseudomys (Smissen & Rowe 2018), we'll make an "Effective Genus" column where this genus is classified under Pseudomys.
```{r}
# Make an Effective Genus column to better categorize Mas phylogenetically
info$EGenus <- info$Genus
info$EGenus[which(info$Genus == "Mas")] <- "Pse"  # Mas is effectively Pse
```

Colors for subsequent figures are set up according to column "EGenus":
```{r}
# Colors by EGenus: Con Hyd Leg Lep Mel Mes Mus Not Pog Pse(+Mas) Rat Uro Xer Zyz
col.gen <- c("light green", "red", "cornflowerblue", "dark green", "yellow", "green", "grey", "blue", "magenta", "dark blue", "black", "darkgoldenrod4", "orange", "light blue")

# Colors by specimen, ordered in same way as metadata
sp.col.gen <- PlotByGroup(info, "EGenus", col.gen)  # is the same for big and small protocols, tested with all.equal()

# Scheme for legend: taxa listed in order presented in phylogeny
col.phylo <- c("yellow", "darkgoldenrod4", "dark green", "green", "light green", "cornflowerblue", "light blue", "blue", "dark blue", "red", "orange", "magenta", "grey", "black")
names.phylo <- c("Mel", "Uro", "Con", "Mes", "Lep", "Leg", "Zyz", "Not", "Pse", "Hyd", "Xer", "Pog", "Mus", "Rat")
```

## 1) Correlation of allometry to PC1 & PC2
Centroid size is a proxy for body size. Usually in GMM studies, the centroid size is highly correlated with PC1, meaning that size increase is likely responsible for shape changes along this axis.

### Test for correlation in PC1
We test for a significant correlation using Pearson's R and plot centroid size versus PC1.
```{r}
# Run PCA
PCA <- plotTangentSpace(shape, groups = sp.col.gen, axis1 = 1, axis2 = 2, verbose = T)

# Find Pearson's r for correlation with PC1
cor <- cor.test(info$Csize, PCA$pc.scores[, 1], method = "pearson")
cor.assoc <- round(unname(cor$estimate), digits = 3)  # round to 3 sig figs
cor.assoc
```

### Plot centroid size versus PC1 to see correlation
```{r}
plot(x = info$Csize, 
     y = PCA$pc.scores[, 1], 
     xlim = c(110, 440), 
     ylim = c(-0.11, 0.14), 
     col = sp.col.gen, 
     pch = 16, 
     xlab = "Centroid size", 
     ylab = "PC1 score", 
     main = "PC1 vs Centroid Size")
legend(413, 0.16, legend = names.phylo, col = col.phylo, pch = 16, cex = 0.78)
text(300, 0, paste("r =", cor.assoc), col = "dark grey")
```

### Test for correlation in PC2
```{r}
# Find Pearson's r for correlation with PC2
cor.PC2 <- cor.test(info$Csize, PCA$pc.scores[, 2], method = "pearson")
cor.assoc.PC2 <- round(unname(cor.PC2$estimate), digits = 3)
cor.pval.PC2 <- round(unname(cor.PC2$p.value), digits = 3)
paste("Correlation is", cor.assoc.PC2, "with p =", cor.pval.PC2) 
```
Correlation of PC2 with size is statistically indistinguishable from 0.


## 2) Static Allometry: Homogeneity of Slopes Test by species
Isolate only those species with at least 8 specimens.
```{r}
spec.counts <- as.data.frame(table(info$Taxa))
to.remove <- spec.counts[which(spec.counts$Freq <= 7), ]
species.rm <- as.vector(to.remove$Var1)

# For loop to take out these specimens
dataset.rm <- NULL  # initiate blank data frame
for(n in 1:dim(to.remove)[1]) {
        dataset.rm <- c(dataset.rm, which(info$Taxa == species.rm[n]))
}

# Remove species from:
info.HOS <- info[c(-dataset.rm), ]  # Metadata
shape.HOS <- shape[, , c(-dataset.rm)]  # Shape dataset
```

Code written with Dr Emma Sheratt to export the p-values of slope differences among all species present in the study.
```{r}
# Run static allometry test
spp.gdf <- geomorph.data.frame(shape = shape.HOS, spp = info.HOS$Taxa, size = info.HOS$Csize)
spp.results <- procD.allometry(shape ~ log(size), f2 = ~spp, data = spp.gdf)

# Examine results
spp.results$aov.table
spp.results$HOS.test

# Find pair-wise p-values for slopes for each taxa
size <- info.HOS$Csize
spp <- info.HOS$Taxa
pwHOS.spp <- advanced.procD.lm(f1 = shape ~log(size) + spp, 
                                     f2 = ~log(size) * spp, 
                                     groups = ~spp,  
                                     slope = ~log(size), 
                                     angle.type = "deg",
                                     data = spp.gdf)

# Export p-values
write.csv(pwHOS.spp$P.slopes.dist, "../Data/Results/19_01_11_static_pwHOS.csv")  # save in Results folder
```

## 3) Static Allometry: Common Allometric Component & Residuals
In _geomorph_, the function `procD.allometry()` does a Procrustes ANOVA with permutation to find patterns of shape covariation with centroid size.
```{r}
# Run Procrustes ANOVA on shape and size with genus as the grouping variable
gdf <- geomorph.data.frame(coords = shape, csize = info$Csize, genus = info$EGenus)
Allo <- procD.allometry(coords ~ csize, ~ genus, logsz = TRUE, iter = 999, RRPP = TRUE, print.progress = TRUE, data = gdf)
summary(Allo)

# Plot results
plot(x = log(Allo$size),
     y = Allo$CAC, 
     xlim = c(4.72, 6.17), 
     col = sp.col.gen, 
     pch = 16, 
     main = "Predicted Allometric Shape by Genus",
     xlab = "Log centroid size", 
     ylab = "Predicted shape")
legend(6.05, 0.115, legend = genus.name, col = col.phylo, pch = 16, cex = 0.78)
```

## Visualize the residual component of shape (size-less shape) as a PCA
```{r}
plot(x = Allo$RSC[, 1],
     y = Allo$RSC[, 2], 
     xlim = c(-0.10, 0.095), # parameters used for PCAs in previous script
     ylim = c(-0.04, 0.07), 
     col = sp.col.gen, 
     pch = 16, 
     main = "Residual shape component (size-less shape)",
     xlab = "RSC PC1", 
     ylab = "RSC PC2")
legend(0.078, 0.077, legend = genus.name, col = col.phylo, pch = 16, cex = 0.78)
```
Size-less shape seems to have few patterns but it's interesting that genus _Rattus_ appears to have greater variation than any other genus. 

## Visualize the residual component of shape as a PCA by immigration wave
```{r}
plot(x = Allo$RSC[, 1],
     y = Allo$RSC[, 2], 
     xlim = c(-0.10, 0.095),
     ylim = c(-0.04, 0.07), 
     col = sp.col.wave, 
     pch = 16, 
     main = "Residual shape component (size-less shape)",
     xlab = "RSC PC1", 
     ylab = "RSC PC2")
legend(-0.11, -0.01, legend = c("AOEs", "Native Rattus", "Invasives"), col = c("blue", "black", "grey"), pch = 16, cex = 0.78)
```
