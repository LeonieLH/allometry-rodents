---
title: "07-find-evolutionary-rates"
author: "Ariel Marcy"
date: "2/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../allometry-rodents')
```

# Evolutionary rates
Evolutionary studies must take into account the phylogenetic tree because related species do not behave the same as independent samples. 

### Load packages, functions, and data
```{r message = FALSE}
library(geomorph)
library(geiger)
library(stringr)
library(RColorBrewer)
library(phylotate)
library(phytools)
source("../Functions/utilities.R")  # loads custom functions
load(file = "../Data/Processed/02-main-data.rda")
load(file = "../Data/Processed/06-phylo-data.rda")
```

## Compare evolutionary rates
Given the New World monkey papers (Chervaud & Marriog 2005, 2009), we would expect specialists like carnivores to have the slowest rates of evolution and rodents that evolve along the allometric line to have the greatest rates of evolution. 

First, we need to make sure the data meets the Brownian motion assumption required by the Kmult method, based on Blomberg's K (Blomberg et al. 2003), 
```{r} 
# Plot disparity through time
mean.shapes.tree.2D <- two.d.array(mean.shapes.tree)
aus.dtt <- dtt(aus.tree, mean.shapes.tree.2D, nsim = 500, plot = TRUE)
```

Next, we can compare evolutionary rates:

**Large frugivores vs others**
```{r}
# Only large frugivores U. caudimaculatus and M. gouldii
U.cau <- which(info.means.tree$Taxa == "U_cau")
M.gou <- which(info.means.tree$Taxa == "M_gou")
is.frug <- c(U.cau, M.gou)
frug.grps <- rep(2, dim(info.means.tree)[1])
frug.grps[is.frug] <- 1

names(frug.grps) <- info.means.tree$FullName
frug.test <- compare.evol.rates(mean.shapes.tree, aus.tree, frug.grps, iter = 499)
summary(frug.test)
```

**Herbivores vs other species**
```{r}
# Only specialized herbivores P. oralis, M. fuscus, and L. conditor 
P.ora <- which(info.means.tree$Taxa == "P_ora")
M.fus <- which(info.means.tree$Taxa == "M_fus")
L.con <- which(info.means.tree$Taxa == "L_con")
is.sp.herb <- c(P.ora, M.fus, L.con)
herb.grps <- rep(2, dim(info.means.tree)[1])
herb.grps[is.sp.herb] <- 1  # species of interest is always 1

names(herb.grps) <- info.means.tree$FullName
herb.test <- compare.evol.rates(mean.shapes.tree, aus.tree, herb.grps, iter = 499)
summary(herb.test)
```

**_Notomys_ versus other species**
```{r}
# Set up grouping factor
gp.notomys <- rep(2, dim(info.means.tree)[1])  # set "other" as 2
gp.notomys[which(info.means.tree$Genus == "Not")] <- 1  # set Notomys
names(gp.notomys) <- info.means.tree$FullName  # required to run analysis

# Run analysis
not.test <- compare.evol.rates(mean.shapes.tree, aus.tree, gp.notomys, iter = 499)
summary(not.test)
```

**Carnivores vs non-carnivores**
```{r}
is.carnivore <- as.numeric(info.means.tree$Feeding != "Carnivorous") + 1  # carnivores are 1 and all other species are 2
names(is.carnivore) <- info.means.tree$FullName
carn.test <- compare.evol.rates(mean.shapes.tree, aus.tree, is.carnivore, iter = 499)
summary(carn.test)
```

### Adjust p-values for multiple comparisons
```{r}
p.values.bon <- round(p.adjust(c(frug.test$P.value, herb.test$P.value, carn.test$P.value, not.test$P.value), method = "hommel"), 3)
```

## Create and export Table 2
```{r}
# Evolutionary rate ratio to 1 decimal place
FindRateRatio <- function(rate.test) {
        round(rate.test$sigma.d.gp[1]/rate.test$sigma.d.gp[2], 1)
}
ratio <- paste("1:", c(FindRateRatio(frug.test), FindRateRatio(herb.test), FindRateRatio(not.test), FindRateRatio(carn.test)), sep = "")

# Expected rate, hard coded from hypotheses
# Order is: frugivores, herbivores, Notomys, carnivores
expected <- c("Faster", "Slower", "Slower", "Slower")

# Rate difference found using custom function FindRateDiff
found <- c(FindRateDiff(frug.test), FindRateDiff(herb.test), FindRateDiff(not.test), FindRateDiff(carn.test))
found[which(p.values.bon > 0.05)] <- "No difference"

# Combine and name rows and columns
table2 <- cbind(ratio, p.values.bon, expected, found)
colnames(table2) <- c("Ratio", "P Value", "Expected Rate", "Rate Found")
row.names(table2) <- c("Frugivores", "Herbivores", "Hopping Notomys", "Carnivores")

# Export Table 2
write.table(table2, "../Data/Results/Table2_EvoRates.csv", sep = ",", col.names = NA)
```

## Plot phylogeny by evolutionary rate and centroid size
```{r}
annotations <- aus.tree$node.comment

# Use function to strip rates from annotated NEXUS file
StripAnnotation <- function(input, annotation) {
        strsplit(strsplit(input, split = annotation)[[1]][2], split = ",")[[1]][1]
}
rates <- as.character(lapply(as.list(annotations), StripAnnotation, annotation = ",rate="))
```

### Isolate rates used for phylogeny in paper
Node rates
```{r}
# Save node rates in node.label vector so it gets handled by drop.tip()
first.node <- length(renamed.tree$tip.label) + 1
renamed.tree$node.label <- rates[first.node:length(rates)]  # grab node rates; length(node.label) should = Nnode

concord <- name.check(renamed.tree, renamed.tree$tip.label, dimnames(mean.shapes.tree)[[3]])  # check concordance
aus.tree <- drop.tip(renamed.tree, concord$tree_not_data)  # prune tree to Aus sample
```

Tip rates
```{r}
aus.rates <- rates[which(!is.element(renamed.tree$tip.label, concord$tree_not_data))]
names(rates) <- aus.tree$tip.label
```

## Plot phylogeny colored by rates and tip.names by phylogeny
```{r}
# Colors by Genus: Hyd Leg Lep Mas Mel Mes Mus Not Pog Pse Rat Uro Xer Zyz
col.gen <- c("red", "cornflowerblue", "dark green", "dark blue", "yellow", "green", "grey", "blue", "magenta", "dark blue", "black", "darkgoldenrod4", "orange", "light blue")

# Colors by species, ordered in same way as tree
grp <- as.factor(str_sub(aus.tree$tip.label, 1, 3))
names(col.gen) <- sort(unique(grp))
col.tree <- col.gen[match(grp, names(col.gen))]

plotBranchbyTrait(aus.tree, as.numeric(aus.rates), palette = "gray", tip.color = col.tree)
```

## Find morphological disparity
```{r}
md.data <- geomorph.data.frame(shape = mean.shapes.tree, size = info.means.tree$MeanCsize, taxa = info.means.tree$Taxa)
morph.disp <- morphol.disparity(f1 = shape ~ size, groups = ~taxa, iter = 499, data = md.data)
```

